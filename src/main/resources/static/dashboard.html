<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Placement Expo</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1>Welcome to Placement Expo</h1>
            <div class="user-info">
                <span id="userEmail"></span>
                <button onclick="logout()">Logout</button>
            </div>
        </header>
        
        <main>
            <section class="profile-section">
                <h2>Your Profile</h2>
                <div id="profileInfo">
                    Loading...
                </div>
            </section>
            
            <section class="jobs-section">
                <h2>Latest Jobs</h2>
                <div id="jobsList">
                    Loading...
                </div>
            </section>
        </main>
    </div>

    <script src="js/appwrite-config.js"></script>
    <script>
        // Check if we're being redirected in a loop
        function checkRedirectLoop() {
            const redirectCount = sessionStorage.getItem('redirectCount') || 0;
            if (redirectCount > 2) {
                sessionStorage.removeItem('redirectCount');
                return true;
            }
            sessionStorage.setItem('redirectCount', Number(redirectCount) + 1);
            return false;
        }

        // On page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Reset redirect counter if this is a direct access
            if (document.referrer === '') {
                sessionStorage.removeItem('redirectCount');
            }
            checkAuth();
        });

        // Check authentication
        async function checkAuth() {
            try {
                const user = await account.get();
                if (!user) {
                    throw new Error('No user found');
                }
                
                // Reset redirect counter on successful auth
                sessionStorage.removeItem('redirectCount');
                
                document.getElementById('userEmail').textContent = user.email;
                loadProfile(user);
            } catch (error) {
                console.error('Authentication error:', error);
                if (!checkRedirectLoop()) {
                    window.location.href = 'login.html';
                } else {
                    // If we detect a redirect loop, clear everything and show error
                    localStorage.clear();
                    sessionStorage.clear();
                    document.body.innerHTML = `
                        <div class="error-container">
                            <h2>Authentication Error</h2>
                            <p>Please <a href="login.html">click here</a> to log in again.</p>
                        </div>
                    `;
                }
            }
        }

        // Load user profile
        async function loadProfile(user) {
            try {
                document.getElementById('profileInfo').innerHTML = `
                    <div class="profile-details">
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Status:</strong> Active</p>
                        <p><strong>Last Login:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('profileInfo').innerHTML = 'Error loading profile';
            }
        }

        // Load jobs
        async function loadJobs() {
            try {
                const response = await fetch('/api/v1/jobs?status=OPEN');
                const jobs = await response.json();
                
                document.getElementById('jobsList').innerHTML = jobs.content
                    .map(job => `
                        <div class="job-card">
                            <h3>${job.title}</h3>
                            <p><strong>Company:</strong> ${job.company}</p>
                            <p><strong>Location:</strong> ${job.location}</p>
                            <p><strong>Type:</strong> ${job.type}</p>
                            <button onclick="viewJob(${job.id})">View Details</button>
                        </div>
                    `)
                    .join('');
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        // Logout function
        async function logout() {
            try {
                await account.deleteSession('current');
                localStorage.clear();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error during logout:', error);
            }
        }

        // View job details
        function viewJob(id) {
            // Implement job details view
            alert('Job details view not implemented yet');
        }

        // Check authentication on page load
        checkAuth();
    </script>
</body>
</html>
