<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - PlacementSyncer</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Ctext x='50' y='60' font-family='Arial, sans-serif' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3EN%3C/text%3E%3C/svg%3E">
    
    <!-- IMMEDIATE CRYPTO POLYFILL - Runs before any extension scripts -->
    <script>
    (function(){
        if(typeof window!=='undefined'){
            window.crypto=window.crypto||{};
            if(!window.crypto.randomUUID){
                window.crypto.randomUUID=function(){
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){
                        var r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);
                        return v.toString(16);
                    });
                };
            }
            if(typeof crypto!=='undefined'&&!crypto.randomUUID){
                crypto.randomUUID=window.crypto.randomUUID;
            }
        }
    })();
    </script>
    
    <script src="js/polyfills.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    <style>
        /* NovaSyncer-inspired Login Layout */
        .nova-login-container {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .nova-login-left {
            flex: 1;
            background: white;
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            max-width: 500px;
        }

        .nova-login-right {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .login-logo {
            display: flex;
            align-items: center;
            margin-bottom: 3rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .login-logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .login-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #718096;
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .login-methods {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .social-btn {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #4a5568;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .social-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .social-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .github-btn {
            border-color: #333;
            background: #333;
            color: white;
        }

        .github-btn:hover {
            background: #24292e;
            border-color: #24292e;
            box-shadow: 0 10px 25px rgba(51, 51, 51, 0.3);
        }

        .google-btn {
            border-color: #4285f4;
            background: #4285f4;
            color: white;
        }

        .google-btn:hover {
            background: #3367d6;
            border-color: #3367d6;
            box-shadow: 0 10px 25px rgba(66, 133, 244, 0.3);
        }

        .social-btn.loading {
            opacity: 0.7;
            cursor: wait;
        }

        .social-btn.loading::before {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .login-divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
            color: #a0aec0;
            font-size: 0.9rem;
        }

        .login-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e2e8f0;
            z-index: 1;
        }

        .login-divider span {
            background: white;
            padding: 0 1rem;
            position: relative;
            z-index: 2;
        }

        .login-form-group {
            margin-bottom: 1.5rem;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .login-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
            background: white;
        }

        .login-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-options {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #4a5568;
        }

        .remember-me input {
            width: 16px;
            height: 16px;
        }

        .forgot-password {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .signup-link {
            text-align: center;
            color: #718096;
            font-size: 0.9rem;
        }

        .signup-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .signup-link a:hover {
            text-decoration: underline;
        }

        /* Right side visual elements */
        .login-visual {
            text-align: center;
            color: white;
            z-index: 2;
            position: relative;
        }

        .login-floating-icons {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
        }

        .login-icon-circle {
            position: absolute;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: float 6s ease-in-out infinite;
        }

        .login-icon-circle:nth-child(1) {
            top: 30%;
            left: 20%;
            animation-delay: 0s;
        }

        .login-icon-circle:nth-child(2) {
            top: 10%;
            right: 30%;
            animation-delay: 2s;
        }

        .login-icon-circle:nth-child(3) {
            bottom: 30%;
            right: 20%;
            animation-delay: 4s;
        }

        .login-dashboard-preview {
            position: absolute;
            top: 50%;
            right: 10%;
            transform: translateY(-50%);
            width: 300px;
            height: 200px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            animation: slideInRight 1s ease-out;
        }

        .login-preview-header {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
        }

        .login-preview-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .login-preview-dot:nth-child(1) { background: #ff5f56; }
        .login-preview-dot:nth-child(2) { background: #ffbd2e; }
        .login-preview-dot:nth-child(3) { background: #27ca3f; }

        .login-preview-content {
            color: white;
            font-size: 0.9rem;
        }

        .login-preview-line {
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .login-preview-line:nth-child(1) { width: 80%; }
        .login-preview-line:nth-child(2) { width: 60%; }
        .login-preview-line:nth-child(3) { width: 90%; }

        .login-visual-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            z-index: 3;
            position: relative;
        }

        .login-visual-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            z-index: 3;
            position: relative;
            max-width: 400px;
            margin: 0 auto;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }

        @media (max-width: 768px) {
            .nova-login-container {
                flex-direction: column;
            }
            
            .nova-login-right {
                min-height: 300px;
            }
            
            .login-dashboard-preview {
                position: relative;
                right: auto;
                top: auto;
                transform: none;
                margin: 2rem auto;
                width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="nova-login-container">
        <!-- Left Panel - Login Form -->
        <div class="nova-login-left">
            <div class="login-logo">
                <div class="login-logo-icon">P</div>
                PlacementSyncer
            </div>

            <div class="login-header">
                <h1>Welcome to PlacementSyncer</h1>
                <p>Choose your preferred method to sign in:</p>
            </div>

            <div class="login-methods">
                <button class="social-btn github-btn" type="button" onclick="loginWithGitHub()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 0C4.477 0 0 4.484 0 10.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z" clip-rule="evenodd"/>
                    </svg>
                    Continue with GitHub
                </button>
                <button class="social-btn google-btn" type="button" onclick="loginWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.792 4.792 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.702 3.702 0 0 0 1.599-2.431H8v-3.08h7.545z"/>
                    </svg>
                    Continue with Google
                </button>
            </div>

            <div class="login-divider">
                <span>or continue with email</span>
            </div>

            <form id="loginForm">
                <div class="login-form-group">
                    <label for="email">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="display: inline; margin-right: 8px;">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                        </svg>
                        Email
                    </label>
                    <input type="email" id="email" name="email" required 
                           placeholder="Enter your email" class="login-input">
                </div>

                <div class="login-form-group">
                    <label for="password">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="display: inline; margin-right: 8px;">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                        Password
                    </label>
                    <input type="password" id="password" name="password" required
                           placeholder="Enter your password" class="login-input">
                </div>

                <div class="login-options">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        Remember me
                    </label>
                    <a href="#" class="forgot-password">Forgot Password?</a>
                </div>

                <button type="submit" class="login-btn">
                    Log In
                </button>
            </form>

            <div class="signup-link">
                Don't have an account? <a href="register.html">Create an account</a>
            </div>
        </div>

        <!-- Right Panel - Visual Section -->
        <div class="nova-login-right">
            <div class="login-floating-icons">
                <div class="login-icon-circle">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </div>
                <div class="login-icon-circle">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-1 16H9V7h9v14z"/>
                    </svg>
                </div>
                <div class="login-icon-circle">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                        <path d="M9 11H7v9a2 2 0 002 2h8a2 2 0 002-2V9a2 2 0 00-2-2h-2V5a1 1 0 00-1-1H10a1 1 0 00-1 1v6z"/>
                    </svg>
                </div>
            </div>

            <div class="login-dashboard-preview">
                <div class="login-preview-header">
                    <div class="login-preview-dot"></div>
                    <div class="login-preview-dot"></div>
                    <div class="login-preview-dot"></div>
                </div>
                <div class="login-preview-content">
                    <div class="login-preview-line"></div>
                    <div class="login-preview-line"></div>
                    <div class="login-preview-line"></div>
                    <div style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.8;">
                        Job matches, profile analytics, skill tracking
                    </div>
                </div>
            </div>

            <div class="login-visual">
                <h2 class="login-visual-title">Connect with every application.</h2>
                <p class="login-visual-subtitle">Everything you need in an easily customizable dashboard.</p>
            </div>
        </div>
    </div>

    <script src="js/appwrite-config.js"></script>
    <script>
        // OAuth Login Functions
        async function loginWithGitHub() {
            const githubBtn = document.querySelector('.github-btn');
            const originalHTML = githubBtn.innerHTML;
            
            try {
                githubBtn.classList.add('loading');
                githubBtn.disabled = true;
                githubBtn.innerHTML = '<span>Connecting to GitHub...</span>';
                
                console.log('Initiating GitHub OAuth login...');
                
                // Clear any existing sessions first
                await clearExistingSessions();
                
                // Create OAuth session with GitHub
                account.createOAuth2Session(
                    'github',
                    `${window.location.origin}/dashboard.html`, // Success URL
                    `${window.location.origin}/login.html` // Failure URL
                );
                
            } catch (error) {
                console.error('GitHub login error:', error);
                githubBtn.classList.remove('loading');
                githubBtn.disabled = false;
                githubBtn.innerHTML = originalHTML;
                
                alert('GitHub login failed: ' + error.message);
            }
        }

        async function loginWithGoogle() {
            const googleBtn = document.querySelector('.google-btn');
            const originalHTML = googleBtn.innerHTML;
            
            try {
                googleBtn.classList.add('loading');
                googleBtn.disabled = true;
                googleBtn.innerHTML = '<span>Connecting to Google...</span>';
                
                console.log('Initiating Google OAuth login...');
                
                // Clear any existing sessions first
                await clearExistingSessions();
                
                // Create OAuth session with Google
                account.createOAuth2Session(
                    'google',
                    `${window.location.origin}/dashboard.html`, // Success URL
                    `${window.location.origin}/login.html` // Failure URL
                );
                
            } catch (error) {
                console.error('Google login error:', error);
                googleBtn.classList.remove('loading');
                googleBtn.disabled = false;
                googleBtn.innerHTML = originalHTML;
                
                alert('Google login failed: ' + error.message);
            }
        }

        // Check if user is returning from OAuth redirect
        async function checkOAuthReturn() {
            try {
                // Check if we have a valid session after OAuth redirect
                const user = await account.get();
                
                if (user) {
                    console.log('OAuth login successful:', user);
                    
                    // Store session data
                    const sessionData = {
                        userId: user.$id,
                        userEmail: user.email,
                        userName: user.name || user.email.split('@')[0],
                        loginTime: new Date().toISOString(),
                        lastActivity: new Date().toISOString(),
                        loginMethod: 'oauth'
                    };
                    
                    localStorage.setItem('sessionData', JSON.stringify(sessionData));
                    localStorage.setItem('userId', user.$id);
                    localStorage.setItem('userEmail', user.email);
                    localStorage.setItem('loginTime', sessionData.loginTime);
                    
                    // Register user in our backend if not exists
                    try {
                        await fetch('/api/v1/auth/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: user.name || user.email.split('@')[0],
                                email: user.email,
                                appwriteId: user.$id
                            })
                        });
                        console.log('User registered in backend successfully');
                    } catch (backendError) {
                        console.warn('Backend registration failed, but continuing with login:', backendError);
                    }
                    
                    // Success notification and redirect
                    console.log('Redirecting to dashboard...');
                    window.location.href = 'dashboard.html';
                    return true;
                }
            } catch (error) {
                console.log('No OAuth session found');
            }
            return false;
        }

        // Check if we're being redirected in a loop
        function checkRedirectLoop() {
            const redirectCount = sessionStorage.getItem('redirectCount') || 0;
            if (redirectCount > 2) {
                sessionStorage.removeItem('redirectCount');
                return true;
            }
            sessionStorage.setItem('redirectCount', Number(redirectCount) + 1);
            return false;
        }

        // Clear any existing sessions
        async function clearExistingSessions() {
            try {
                await account.deleteSessions();
            } catch (error) {
                console.log('No active sessions to clear');
            }
        }

        // On page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('PlacementSyncer Login Page Loaded');
            
            // Check if returning from OAuth first
            const isOAuthReturn = await checkOAuthReturn();
            if (isOAuthReturn) {
                return; // Will redirect to dashboard
            }
            
            // Clear redirect counter if this is a fresh page load
            if (document.referrer === '') {
                sessionStorage.removeItem('redirectCount');
            }

            // Clear any existing sessions on login page load
            await clearExistingSessions();

            // Check for prefilled email
            const prefilledEmail = localStorage.getItem('prefilledEmail');
            if (prefilledEmail) {
                const emailInput = document.getElementById('email');
                if (emailInput) {
                    emailInput.value = prefilledEmail;
                    localStorage.removeItem('prefilledEmail');
                }
            }

            // Add entrance animation
            const leftPanel = document.querySelector('.nova-login-left');
            if (leftPanel) {
                leftPanel.style.opacity = '0';
                leftPanel.style.transform = 'translateX(-30px)';
                
                setTimeout(() => {
                    leftPanel.style.transition = 'all 0.8s ease';
                    leftPanel.style.opacity = '1';
                    leftPanel.style.transform = 'translateX(0)';
                }, 100);
            }
            
            console.log('Login page ready for authentication');
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('.login-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing in...';
            submitBtn.disabled = true;
            
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                // Clear existing sessions more carefully
                try {
                    // First check if there's already a session
                    try {
                        const currentUser = await account.get();
                        if (currentUser) {
                            await account.deleteSession('current');
                            console.log('Cleared existing session');
                        }
                    } catch (getError) {
                        // No session to clear, continue
                        console.log('No existing session found');
                    }
                } catch (deleteError) {
                    console.warn('Could not clear existing session:', deleteError);
                    // Continue anyway
                }

                // Create new session with retry logic for rate limiting
                let session;
                let retryCount = 0;
                const maxRetries = 3;
                const baseDelay = 2000; // 2 seconds base delay
                
                while (retryCount < maxRetries) {
                    try {
                        session = await account.createEmailSession(email, password);
                        console.log('Session created successfully');
                        break; // Success, exit retry loop
                    } catch (sessionError) {
                        if (sessionError.message && sessionError.message.toLowerCase().includes('rate limit') && retryCount < maxRetries - 1) {
                            retryCount++;
                            const waitTime = baseDelay * retryCount; // 2, 4, 6 seconds
                            console.warn(`Rate limit detected, waiting ${waitTime/1000} seconds before retry ${retryCount}/${maxRetries}`);
                            submitBtn.textContent = `Rate limited - retrying in ${waitTime/1000}s...`;
                            
                            // Wait before retry
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                            submitBtn.textContent = 'Retrying login...';
                        } else {
                            throw sessionError; // Re-throw if not rate limit or max retries reached
                        }
                    }
                }
                
                if (!session) {
                    throw new Error('Failed to create session after ' + maxRetries + ' attempts');
                }
                
                // Get user data with retry
                let user;
                try {
                    user = await account.get();
                } catch (userError) {
                    console.warn('Could not get user data immediately, retrying...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    user = await account.get();
                }
                
                // Store comprehensive session data
                const sessionData = {
                    sessionId: session.$id,
                    userId: user.$id,
                    userEmail: user.email,
                    userName: user.name || email.split('@')[0],
                    loginTime: new Date().toISOString(),
                    lastActivity: new Date().toISOString()
                };
                
                localStorage.setItem('sessionData', JSON.stringify(sessionData));
                localStorage.setItem('sessionId', session.$id);
                localStorage.setItem('userId', user.$id);
                localStorage.setItem('userEmail', user.email);
                localStorage.setItem('loginTime', sessionData.loginTime);
                
                console.log('User authenticated and data stored:', user);
                
                // Success animation
                submitBtn.textContent = 'Success!';
                submitBtn.style.background = 'linear-gradient(135deg, #38a169, #48bb78)';
                
                // Redirect to dashboard with slight delay for UX
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
                
            } catch (error) {
                console.error('Login error:', error);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                submitBtn.style.background = 'linear-gradient(135deg, #e53e3e, #fc8181)';
                
                // Handle different error types
                let errorMessage = 'Login failed: ' + error.message;
                if (error.message && error.message.toLowerCase().includes('rate limit')) {
                    errorMessage = 'Too many login attempts. Please wait a moment and try again.';
                } else if (error.message && error.message.toLowerCase().includes('invalid credentials')) {
                    errorMessage = 'Invalid email or password. Please check your credentials.';
                } else if (error.message && error.message.toLowerCase().includes('user not found')) {
                    errorMessage = 'No account found with this email. Please register first.';
                } else if (error.message && error.message.toLowerCase().includes('session')) {
                    errorMessage = 'Session error. Please try again in a few moments.';
                }
                
                alert(errorMessage);
                
                // Reset button after error
                setTimeout(() => {
                    submitBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                }, 3000);
            }
        });
    </script>
</body>
</html>
