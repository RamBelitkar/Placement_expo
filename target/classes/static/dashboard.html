<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Dashboard - PlacementSyncer</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/dashboard-ats.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    <script src="js/appwrite-config.js"></script>
    <script src="js/resume-upload.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>PlacementSyncer</h1>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link active">Dashboard</a>
                <a href="registration.html" class="nav-link">Update Profile</a>
                <a href="jobs.html" class="nav-link">Jobs</a>
                <a href="applications.html" class="nav-link">Applications</a>
            </div>
            <div class="nav-user">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <span class="user-name" id="userName">Loading...</span>
                    <span class="user-email" id="userEmail">Loading...</span>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Header -->
            <section class="dashboard-header">
                <h1>Welcome Back!</h1>
                <p>Here's your profile overview and recent activity</p>
            </section>

            <!-- Profile Summary Cards -->
            <section class="summary-cards">
                <div class="card profile-card">
                    <div class="card-header">
                        <h3>üë§ Profile Overview</h3>
                    </div>
                    <div class="card-content">
                        <div class="stat">
                            <span class="stat-number" id="profileScore">0</span>
                            <span class="stat-label">Profile Score</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="profileViews">0</span>
                            <span class="stat-label">Profile Views</span>
                        </div>
                        <p class="card-description" id="profileCompletionText">Loading profile data...</p>
                    </div>
                </div>

                <div class="card applications-card">
                    <div class="card-header">
                        <h3>üíº Job Applications</h3>
                    </div>
                    <div class="card-content">
                        <div class="stat">
                            <span class="stat-number" id="totalApplications">0</span>
                            <span class="stat-label">Total Applied</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="interviewsAttended">0</span>
                            <span class="stat-label">Interviews</span>
                        </div>
                        <p class="card-description" id="jobMatchesText">Loading job matches...</p>
                    </div>
                </div>
            </section>

            <!-- Profile Details -->
            <section class="profile-details">
                <div class="details-card">
                    <h3>Personal Information</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>Full Name</label>
                            <span id="profileName">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <span id="profileEmail">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <label>Phone</label>
                            <span id="profilePhone">Not provided</span>
                        </div>
                        <div class="detail-item">
                            <label>Department</label>
                            <span id="profileDepartment">Not specified</span>
                        </div>
                        <div class="detail-item">
                            <label>Year</label>
                            <span id="profileYear">Not specified</span>
                        </div>
                        <div class="detail-item">
                            <label>CGPA</label>
                            <span id="profileCgpa">Not specified</span>
                        </div>
                    </div>
                </div>
                
                <!-- ATS Score Section (if resume uploaded) -->
                <div class="details-card" id="atsScoreCard" style="display: none;padding-top: 2rem;">
                    <h3>Resume ATS Score</h3>
                    <div class="ats-score-container">
                        <div class="ats-score-circle">
                            <span id="atsScoreValue">0</span>
                            <span class="ats-score-label">Score</span>
                        </div>
                        <div class="ats-feedback">
                            <h4>ATS Feedback</h4>
                            <p id="atsFeedback">Your resume has not been analyzed yet.</p>
                        </div>
                    </div>
                </div>
                
                <!-- ATS Score Not Available Section -->
                <div class="details-card" id="resumeUploadCard">
                    <h3>Resume ATS Analysis</h3>
                    <div class="upload-container">
                        <p>You haven't uploaded a resume yet or your resume hasn't been analyzed.</p>
                        <p>Please update your profile by uploading a resume in the Update Profile section.</p>
                        <a href="registration.html" class="btn btn-primary">Update Profile</a>
                    </div>
                </div>
            </section>

            <!-- Recommended Jobs -->
            <section class="recommended-jobs">
                <h3>üéØ Recommended Jobs</h3>
                <div class="jobs-list">
                    <div class="job-card">
                        <div class="job-header">
                            <h4>Senior Frontend Developer</h4>
                            <span class="job-status status-open">Open</span>
                        </div>
                        <p class="job-company">TechCorp ‚Ä¢ Remote ‚Ä¢ $80k-$120k</p>
                        <div class="job-actions">
                            <button class="btn btn-primary">Apply Now</button>
                            <button class="btn btn-secondary">Save</button>
                        </div>
                    </div>

                    <div class="job-card">
                        <div class="job-header">
                            <h4>Full Stack Engineer</h4>
                            <span class="job-status status-applied">Applied</span>
                        </div>
                        <p class="job-company">StartupXYZ ‚Ä¢ San Francisco ‚Ä¢ $90k-$130k</p>
                        <div class="job-actions">
                            <button class="btn btn-secondary">View Application</button>
                            <button class="btn btn-secondary">Withdraw</button>
                        </div>
                    </div>

                    <div class="job-card">
                        <div class="job-header">
                            <h4>React Developer</h4>
                            <span class="job-status status-interview">Interview</span>
                        </div>
                        <p class="job-company">InnovateLabs ‚Ä¢ New York ‚Ä¢ $75k-$110k</p>
                        <div class="job-actions">
                            <button class="btn btn-success">Schedule Interview</button>
                            <button class="btn btn-secondary">View Details</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="recent-activity">
                <h3>üìà Recent Activity</h3>
                <div class="activity-list">
                    <div class="activity-item">
                        <div class="activity-icon">‚úÖ</div>
                        <div class="activity-content">
                            <h4>Application Submitted</h4>
                            <p>Applied to Senior Frontend Developer at TechCorp</p>
                            <span class="activity-time">2 hours ago</span>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-icon">üëÅÔ∏è</div>
                        <div class="activity-content">
                            <h4>Profile Viewed</h4>
                            <p>Your profile was viewed by 5 recruiters this week</p>
                            <span class="activity-time">1 day ago</span>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-icon">üéØ</div>
                        <div class="activity-content">
                            <h4>New Job Match</h4>
                            <p>3 new jobs match your skills and preferences</p>
                            <span class="activity-time">2 days ago</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        // Session Management and Authentication
        let currentUser = null;
        let sessionData = null;

        // Check authentication status on page load
        async function checkAuthStatus() {
            try {
                // Check if session data exists in localStorage
                const storedSessionData = localStorage.getItem('sessionData');
                
                if (!storedSessionData) {
                    console.log('No session data found, redirecting to login');
                    redirectToLogin();
                    return false;
                }

                sessionData = JSON.parse(storedSessionData);
                
                // Verify session with Appwrite
                try {
                    currentUser = await account.get();
                    console.log('Session verified with Appwrite:', currentUser);
                    
                    // Load hybrid dashboard data from backend
                    await loadHybridDashboardData();
                    
                    return true;
                    
                } catch (sessionError) {
                    console.warn('Session verification failed:', sessionError);
                    
                    // If session is expired, clear data and redirect
                    if (sessionError.code === 401 || sessionError.message?.includes('401')) {
                        console.log('Session expired, clearing data and redirecting');
                        clearSessionData();
                        redirectToLogin();
                        return false;
                    }
                    
                    // For other errors, try to use stored data
                    console.log('Using stored session data due to network/server issues');
                    updateUserInterface();
                    return true;
                }
                
            } catch (error) {
                console.error('Auth check error:', error);
                clearSessionData();
                redirectToLogin();
                return false;
            }
        }

        // Load dashboard data from hybrid system (Appwrite + Spring Boot)
        async function loadHybridDashboardData() {
            try {
                console.log('Loading hybrid dashboard data...');
                
                // Get extended profile and applications from Spring Boot API
                const response = await fetch('/api/v1/profile-simple/dashboard', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Appwrite-User-Id': currentUser.$id,
                        'X-Appwrite-User-Email': currentUser.email
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        // Profile not found, redirect to registration
                        console.log('Profile not found, redirecting to registration');
                        alert('Please complete your profile registration first.');
                        window.location.href = 'registration.html';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('=== RAW API RESPONSE ===');
                console.log('Full API response:', result);
                
                if (result.success && result.data) {
                    const dashboardData = result.data;
                    console.log('=== DASHBOARD DATA EXTRACTED ===');
                    console.log('Dashboard data loaded:', dashboardData);
                    console.log('User profile data:', dashboardData.userProfile);
                    
                    // Update session data with hybrid info
                    sessionData = {
                        ...sessionData,
                        userName: dashboardData.userProfile.fullName || currentUser.name,
                        userEmail: dashboardData.userProfile.email || currentUser.email,
                        profileCompletionPercentage: dashboardData.userProfile.completionPercentage,
                        profileComplete: true,
                        lastActivity: new Date().toISOString()
                    };
                    
                    localStorage.setItem('sessionData', JSON.stringify(sessionData));
                    console.log('Session data updated:', sessionData);
                    
                    // Update UI with hybrid data
                    console.log('=== STARTING UI UPDATE ===');
                    updateHybridDashboardUI(dashboardData);
                    console.log('=== UI UPDATE COMPLETED ===');
                    
                } else {
                    console.error('API returned error:', result);
                    throw new Error(result.message || 'Failed to load dashboard data');
                }
                
            } catch (error) {
                console.error('Failed to load hybrid dashboard data:', error);
                
                if (error.message.includes('404') || error.message.includes('not found')) {
                    console.log('Profile incomplete, showing basic UI');
                } else {
                    console.warn('Using basic session data due to API error');
                }
                
                // Fallback to basic session data
                updateUserInterface();
            }
        }

        // Update dashboard UI with hybrid data
        function updateHybridDashboardUI(dashboardData) {
            // Update basic UI first
            updateUserInterface();
            
            // Update statistics cards - pass the entire dashboardData
            updateStatisticsCards(dashboardData);
            
            // Update profile details
            if (dashboardData.userProfile) {
                updateProfileDetails(dashboardData.userProfile);
            }
            
            // Update recent applications
            if (dashboardData.recentApplications && dashboardData.recentApplications.length > 0) {
                updateRecentApplications(dashboardData.recentApplications);
            } else {
                // Show placeholder if no applications
                const jobsList = document.querySelector('.jobs-list');
                if (jobsList) {
                    jobsList.innerHTML = '<div class="empty-state">No applications yet. Start applying to jobs to see them here.</div>';
                }
            }
            
            // Update recent activity
            if (dashboardData.recentActivity && dashboardData.recentActivity.length > 0) {
                updateRecentActivity(dashboardData.recentActivity);
            } else {
                // Show placeholder if no activity
                const activityList = document.querySelector('.activity-list');
                if (activityList) {
                    activityList.innerHTML = '<div class="empty-state">No recent activity. Get started by completing your profile.</div>';
                }
            }
        }

        // Update statistics cards
        function updateStatisticsCards(stats) {
            console.log('=== UPDATING STATISTICS CARDS ===');
            console.log('Statistics data received:', stats);
            
            // Profile Overview Card
            const profileScore = document.getElementById('profileScore');
            const profileViews = document.getElementById('profileViews');
            const profileCompletionText = document.getElementById('profileCompletionText');
            
            if (profileScore) {
                profileScore.textContent = stats.userProfile?.completionPercentage || '0';
            }
            if (profileViews) {
                // Use statistics.profileViews instead of direct profileViews
                profileViews.textContent = stats.statistics?.profileViews || '0';
            }
            if (profileCompletionText) {
                const completionPercentage = stats.userProfile?.completionPercentage || 0;
                profileCompletionText.textContent = `Your profile is ${completionPercentage}% complete. ${completionPercentage < 100 ? 'Complete your profile to improve visibility.' : 'Your profile is complete!'}`;
            }
            
            // Job Applications Card
            const totalApplications = document.getElementById('totalApplications');
            const interviewsAttended = document.getElementById('interviewsAttended');
            const jobMatchesText = document.getElementById('jobMatchesText');
            
            if (totalApplications) {
                // Use statistics.totalApplications instead of direct totalApplications
                totalApplications.textContent = stats.statistics?.totalApplications || '0';
            }
            if (interviewsAttended) {
                // Use statistics.interviewsAttended instead of direct interviewsAttended
                interviewsAttended.textContent = stats.statistics?.interviewsAttended || '0';
            }
            if (jobMatchesText) {
                const jobMatches = 3; // Could come from API in the future
                jobMatchesText.textContent = `${jobMatches} new job matches available based on your profile.`;
            }
            
            console.log('=== STATISTICS CARDS UPDATE COMPLETE ===');
        }

        // Update profile details with hybrid data
        function updateProfileDetails(profile) {
            console.log('=== UPDATING PROFILE DETAILS ===');
            console.log('Profile data received:', profile);
            
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const profilePhone = document.getElementById('profilePhone');
            const profileDepartment = document.getElementById('profileDepartment');
            const profileYear = document.getElementById('profileYear');
            const profileCgpa = document.getElementById('profileCgpa');
            const atsScoreCard = document.getElementById('atsScoreCard');
            const atsScoreValue = document.getElementById('atsScoreValue');
            const atsFeedback = document.getElementById('atsFeedback');
            
            // Basic profile details
            if (profileName) {
                profileName.textContent = profile.fullName || 'Not provided';
            }
            if (profileEmail) {
                profileEmail.textContent = profile.email || 'Not provided';
            }
            if (profilePhone) {
                profilePhone.textContent = profile.phone || 'Not provided';
            }
            if (profileDepartment) {
                profileDepartment.textContent = profile.department || 'Not specified';
            }
            if (profileYear) {
                profileYear.textContent = profile.currentYear ? `Year ${profile.currentYear}` : 'Not specified';
            }
            if (profileCgpa) {
                profileCgpa.textContent = profile.currentCgpa || 'Not specified';
            }
            
            // ATS Score section
            const resumeUploadCard = document.getElementById('resumeUploadCard');
            
            if (atsScoreCard && atsScoreValue && atsFeedback) {
                if (profile.atsScore > 0 || (profile.atsFeedback && profile.atsFeedback !== 'Resume not yet analyzed')) {
                    // Show ATS score if available
                    atsScoreCard.style.display = 'block';
                    atsScoreValue.textContent = profile.atsScore || '0';
                    atsFeedback.textContent = profile.atsFeedback || 'Your resume has not been analyzed yet.';
                    
                    // Hide resume upload card
                    if (resumeUploadCard) {
                        resumeUploadCard.style.display = 'none';
                    }
                } else {
                    // No ATS score, show upload card instead
                    atsScoreCard.style.display = 'none';
                    if (resumeUploadCard) {
                        resumeUploadCard.style.display = 'block';
                    }
                }
            }
            
            console.log('=== PROFILE DETAILS UPDATE COMPLETE ===');
        }

        // Update recent applications
        function updateRecentApplications(applications) {
            const jobsList = document.querySelector('.jobs-list');
            if (!jobsList || !applications.length) return;
            
            // Clear existing job cards and add real data
            jobsList.innerHTML = '';
            
            applications.slice(0, 3).forEach(app => {
                const jobCard = createJobCard(app);
                jobsList.appendChild(jobCard);
            });
        }

        // Create job card element
        function createJobCard(application) {
            const card = document.createElement('div');
            card.className = 'job-card';
            
            const statusClass = `status-${application.status.toLowerCase().replace('_', '-')}`;
            const statusColor = application.statusColor || 'blue';
            
            card.innerHTML = `
                <div class="job-header">
                    <h4>${application.positionTitle}</h4>
                    <span class="job-status ${statusClass}" style="background-color: ${statusColor}20; color: ${statusColor};">${application.status}</span>
                </div>
                <p class="job-company">${application.companyName} ‚Ä¢ Applied ${new Date(application.applicationDate).toLocaleDateString()}</p>
                <div class="job-actions">
                    <button class="btn btn-secondary">View Details</button>
                    ${application.status === 'APPLIED' ? '<button class="btn btn-primary">Follow Up</button>' : ''}
                </div>
            `;
            
            return card;
        }

        // Update recent activity
        function updateRecentActivity(activities) {
            const activityList = document.querySelector('.activity-list');
            if (!activityList) return;
            
            // Clear existing activities
            activityList.innerHTML = '';
            
            activities.slice(0, 5).forEach(activity => {
                const activityItem = createActivityItem(activity);
                activityList.appendChild(activityItem);
            });
        }

        // Create activity item element
        function createActivityItem(activity) {
            const item = document.createElement('div');
            item.className = 'activity-item';
            
            const timeAgo = getTimeAgo(new Date(activity.timestamp));
            
            item.innerHTML = `
                <div class="activity-icon">${activity.icon}</div>
                <div class="activity-content">
                    <h4>${activity.title}</h4>
                    <p>${activity.description}</p>
                    <span class="activity-time">${timeAgo}</span>
                </div>
            `;
            
            return item;
        }

        // Helper function to get relative time
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) return `${diffMins} minutes ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        // Update UI with user data
        function updateUserInterface() {
            if (!sessionData) return;

            // Update navigation
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');
            const userAvatar = document.getElementById('userAvatar');

            if (userName) userName.textContent = sessionData.userName || 'User';
            if (userEmail) userEmail.textContent = sessionData.userEmail || 'user@example.com';
            if (userAvatar) {
                const firstLetter = (sessionData.userName || sessionData.userEmail || 'U').charAt(0).toUpperCase();
                userAvatar.textContent = firstLetter;
            }

            // Update profile details
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');

            if (profileName) profileName.textContent = sessionData.userName || 'User';
            if (profileEmail) profileEmail.textContent = sessionData.userEmail || 'user@example.com';

            // Update welcome message
            const welcomeHeader = document.querySelector('.dashboard-header h1');
            if (welcomeHeader) {
                const firstName = (sessionData.userName || 'User').split(' ')[0];
                welcomeHeader.textContent = `Welcome Back, ${firstName}!`;
            }

            console.log('UI updated with user data:', sessionData);
        }

        // Logout functionality
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    // Show loading state
                    const logoutBtn = document.querySelector('.logout-btn');
                    const originalText = logoutBtn.textContent;
                    logoutBtn.textContent = 'Logging out...';
                    logoutBtn.disabled = true;

                    // Try to delete session from Appwrite
                    try {
                        await account.deleteSession('current');
                        console.log('Session deleted from Appwrite');
                    } catch (deleteError) {
                        console.warn('Could not delete session from server:', deleteError);
                        // Continue with local cleanup even if server deletion fails
                    }

                    // Clear local session data
                    clearSessionData();

                    // Redirect to login
                    window.location.href = 'login.html';

                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed. Please try again.');
                    
                    // Reset button state
                    const logoutBtn = document.querySelector('.logout-btn');
                    logoutBtn.textContent = 'Logout';
                    logoutBtn.disabled = false;
                }
            }
        }

        // Clear all session data
        function clearSessionData() {
            localStorage.removeItem('sessionData');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('loginTime');
            sessionData = null;
            currentUser = null;
        }

        // Redirect to login page
        function redirectToLogin() {
            window.location.href = 'login.html';
        }

        // Update last activity timestamp
        function updateLastActivity() {
            if (sessionData) {
                sessionData.lastActivity = new Date().toISOString();
                localStorage.setItem('sessionData', JSON.stringify(sessionData));
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Dashboard initializing with hybrid approach...');

            // Check authentication and load hybrid data
            const isAuthenticated = await checkAuthStatus();
            
            if (!isAuthenticated) {
                return; // Will redirect to login
            }

            // Note: Hybrid data loading already done in checkAuthStatus()
            console.log('Dashboard ready with hybrid backend integration');

            // Add activity tracking
            document.addEventListener('click', updateLastActivity);
            document.addEventListener('keypress', updateLastActivity);

            // Add interactivity to cards
            const cards = document.querySelectorAll('.card, .job-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });

            // Set up periodic session validation (every 5 minutes)
            setInterval(async () => {
                try {
                    await account.get();
                    updateLastActivity();
                } catch (error) {
                    console.warn('Periodic session check failed:', error);
                    if (error.code === 401 || error.message?.includes('401')) {
                        alert('Your session has expired. Please login again.');
                        clearSessionData();
                        redirectToLogin();
                    }
                }
            }, 5 * 60 * 1000); // 5 minutes

            // No need for separate resume upload on dashboard
            // The ATS analysis happens during registration
            
            console.log('Dashboard loaded successfully');
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, update activity
                updateLastActivity();
            }
        });
    </script>
</body>
</html>
